name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒåŠä»£ç†ç¨‹åº

on:
  workflow_dispatch:
    inputs:
      tags:
        description: "Tags to push (comma-separated, e.g., latest,v1.0.0)"
        required: true
        default: "latest"

env:
  IMAGE_NAME: pt-nexus

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 1.5. ä¸‹è½½ æ‰¹é‡è½¬ç§ ç¨‹åº
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          PRIVATE_REPO_URL: ${{ secrets.PRIVATE_REPO_URL }}
        run: |
          if [ -n "$PRIVATE_REPO_TOKEN" ] && [ -n "$PRIVATE_REPO_URL" ]; then
            echo "ğŸ“¥ ä¸‹è½½ æ‰¹é‡è½¬ç§ ç¨‹åº"
            
            # åˆ›å»º batch-enhancer ç›®å½•
            mkdir -p batch-enhancer
            
            # ä¸‹è½½ main.go æ–‡ä»¶
            curl -H "Authorization: token $PRIVATE_REPO_TOKEN" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -L "$PRIVATE_REPO_URL/refs/heads/main/batch-enhancer/main.go" \
                 -o batch-enhancer/main.go
            
            if [ -f batch-enhancer/main.go ]; then
              echo "âœ… æˆåŠŸä¸‹è½½ batch-enhancer/main.go"
              echo "æ–‡ä»¶å¤§å°: $(wc -l < batch-enhancer/main.go) è¡Œ"
            else
              echo "âŒ ä¸‹è½½ batch-enhancer/main.go å¤±è´¥"
              exit 1
            fi
          else
            echo "âš ï¸  æœªé…ç½®ç§æœ‰ä»“åº“è®¿é—®ä¿¡æ¯ï¼Œè·³è¿‡æ–‡ä»¶ä¸‹è½½"
            echo "   è¯·è®¾ç½® PRIVATE_REPO_TOKEN å’Œ PRIVATE_REPO_URL secrets"
          fi

      - name: 2. è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: 3. è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 4. ç™»å½•åˆ° GitHub Container Registry (ghcr.io)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 5. ç™»å½•åˆ° Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 6. å‡†å¤‡ Docker æ ‡ç­¾
        id: prepare-tags
        run: |
          # è¯»å–ç”¨æˆ·è¾“å…¥çš„æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰
          INPUT_TAGS="${{ github.event.inputs.tags }}"

          # å‡†å¤‡ä¸¤ä¸ªä»“åº“çš„å®Œæ•´æ ‡ç­¾åˆ—è¡¨
          GHCR_REPO="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          DOCKERHUB_REPO="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"

          # å°†é€—å·åˆ†éš”çš„æ ‡ç­¾è½¬æ¢ä¸ºå®Œæ•´çš„é•œåƒæ ‡ç­¾
          TAGS=""
          IFS=',' read -ra TAG_ARRAY <<< "$INPUT_TAGS"
          for tag in "${TAG_ARRAY[@]}"; do
            # å»é™¤é¦–å°¾ç©ºæ ¼
            tag=$(echo "$tag" | xargs)
            # æ·»åŠ ä¸¤ä¸ªä»“åº“çš„æ ‡ç­¾
            TAGS="${TAGS}${GHCR_REPO}:${tag},"
            TAGS="${TAGS}${DOCKERHUB_REPO}:${tag},"
          done

          # ç§»é™¤æœ€åçš„é€—å·
          TAGS="${TAGS%,}"

          echo "ç”Ÿæˆçš„æ ‡ç­¾: $TAGS"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: 7. æ„å»ºå¹¶æ¨é€åˆ°å¤šä¸ªé•œåƒä»“åº“
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.prepare-tags.outputs.tags }}

  build-pt-nexus-box-proxy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: write

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: 3. æ„å»ºå¤šå¹³å°ä»£ç†ç¨‹åº
        run: |
          cd proxy
          mkdir -p releases

          # å®šä¹‰è¦æ„å»ºçš„å¹³å°
          PLATFORMS=("linux/amd64" "linux/arm64")

          # ä¸ºæ¯ä¸ªå¹³å°æ„å»º
          for platform in "${PLATFORMS[@]}"; do
            IFS='/' read -ra ADDR <<< "$platform"
            OS="${ADDR[0]}"
            ARCH="${ADDR[1]}"

            echo "æ„å»ºå¹³å°: $OS/$ARCH"

            # è®¾ç½®ç¯å¢ƒå˜é‡
            export GOOS=$OS
            export GOARCH=$ARCH
            export CGO_ENABLED=0

            # è®¾ç½®è¾“å‡ºæ–‡ä»¶å
            if [ "$OS" = "windows" ]; then
              OUTPUT_NAME="pt-nexus-box-proxy-$OS-$ARCH.exe"
            else
              OUTPUT_NAME="pt-nexus-box-proxy-$OS-$ARCH"
            fi

            # æ„å»º
            go build -a -installsuffix cgo -o "releases/$OUTPUT_NAME" .

            # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
            if [ $? -ne 0 ]; then
              echo "æ„å»ºå¤±è´¥: $OS/$ARCH"
              exit 1
            fi

            echo "æˆåŠŸæ„å»º: $OUTPUT_NAME"
          done

      - name: 4. å‡†å¤‡ Release æ ‡ç­¾
        id: prepare-release-tag
        run: |
          # ä»è¾“å…¥çš„æ ‡ç­¾ä¸­æå–ç¬¬ä¸€ä¸ªä½œä¸º release tag
          INPUT_TAGS="${{ github.event.inputs.tags }}"
          FIRST_TAG=$(echo "$INPUT_TAGS" | cut -d',' -f1 | xargs)
          echo "ä½¿ç”¨çš„ Release æ ‡ç­¾: $FIRST_TAG"
          echo "tag=$FIRST_TAG" >> $GITHUB_OUTPUT

      - name: 5. åˆ›å»º Release å¹¶ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶å’Œå®‰è£…è„šæœ¬
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.prepare-release-tag.outputs.tag }}
          name: Release ${{ steps.prepare-release-tag.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            proxy/releases/pt-nexus-box-proxy-*
            proxy/install-pt-nexus-box-proxy.sh
