# Docker 部署

> **注：** 旧版本更新到 v3.0.0 版本因为数据库有很大变化，需要删除原来的数据库的所有表，然后代码会重新创建新的表，可以使用`docker run -p 8080:8080 adminer`进行修改。

#### 环境变量

| 分类       | 参数              | 说明                                           | 示例                      |
| ---------- | ----------------- | ---------------------------------------------- | ------------------------- |
| **通用**   | TZ                | 设置容器时区，确保时间与日志准确。             | Asia/Shanghai             |
|            | http_proxy        | 设置容器代理，确保能正常访问站点与各种服务。   | http://192.168.1.100:7890 |
|            | https_proxy       | 设置容器代理，确保能正常访问站点与各种服务。   | http://192.168.1.100:7890 |
| **数据库** | DB_TYPE           | 选择数据库类型。sqlite、mysql 或  postgresql。 | sqlite                    |
|            | MYSQL_HOST        | **(MySQL 专用)**  数据库主机地址。             | 192.168.1.100             |
|            | MYSQL_PORT        | **(MySQL 专用)**  数据库端口。                 | 3306                      |
|            | MYSQL_DATABASE    | **(MySQL 专用)**  数据库名称。                 | pt-nexus                  |
|            | MYSQL_USER        | **(MySQL 专用)**  数据库用户名。               | root                      |
|            | MYSQL_PASSWORD    | **(MySQL 专用)**  数据库密码。                 | your_password             |
|            | POSTGRES_HOST     | **(PostgreSQL 专用)**  数据库主机地址。        | 192.168.1.100             |
|            | POSTGRES_PORT     | **(PostgreSQL 专用)**  数据库端口。            | 5432                      |
|            | POSTGRES_DATABASE | **(PostgreSQL 专用)**  数据库名称。            | pt-nexus                  |
|            | POSTGRES_USER     | **(PostgreSQL 专用)**  数据库用户名。          | root                      |
|            | POSTGRES_PASSWORD | **(PostgreSQL 专用)**  数据库密码。            | your_password             |

#### Docker Compose 示例

1. 创建 `docker-compose.yml` 文件

```yaml
# 使用 sqlite
services:
  pt-nexus:
    image: ghcr.nju.edu.cn/sqing33/pt-nexus:latest
    container_name: pt-nexus
    ports:
      - 5274:5274
    volumes:
      - ./data:/app/data
      - /vol3/1000/pt:/pt # 与 qb 或者 tr 设置的文件下载目录一致
    environment:
      - TZ=Asia/Shanghai
      - http_proxy=http://192.168.1.100:7890
      - https_proxy=http://192.168.1.100:7890
      - DB_TYPE=sqlite
```

```yaml
# 使用 MySQL
services:
  pt-nexus:
    image: ghcr.nju.edu.cn/sqing33/pt-nexus:latest
    container_name: pt-nexus
    ports:
      - 5274:5274
    volumes:
      - ./data:/app/data
      - /vol3/1000/pt:/pt # 与 qb 或者 tr 设置的文件下载目录一致
    environment:
      - TZ=Asia/Shanghai
      - http_proxy=http://192.168.1.100:7890
      - https_proxy=http://192.168.1.100:7890
      - DB_TYPE=mysql
      - MYSQL_HOST=192.168.1.100
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=pt_nexus
      - MYSQL_USER=root
      - MYSQL_PASSWORD=your_password
```

```yaml
# 使用 PostgreSQL
services:
  pt-nexus:
    image: ghcr.nju.edu.cn/sqing33/pt-nexus:latest
    container_name: pt-nexus
    ports:
      - 5274:5274
    volumes:
      - ./data:/app/data
      - /vol3/1000/pt:/pt # 与 qb 或者 tr 设置的文件下载目录一致
    environment:
      - TZ=Asia/Shanghai
      - http_proxy=http://192.168.1.100:7890
      - https_proxy=http://192.168.1.100:7890
      - DB_TYPE=postgresql
      - POSTGRES_HOST=192.168.1.100
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=pt-nexus
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=your_password
```

2.  在与 `docker-compose.yml` 相同的目录下，运行以下命令启动服务：
    ```bash
    docker-compose up -d
    ```
3.  服务启动后，通过 `http://<你的服务器IP>:5274` 访问 PT Nexus 界面。

#### 登录

1. 首次登录默认用户名为 `admin`，随机密码在容器日志查看。
2. 登录成功后请到`设置`-`用户管理`页面修改用户名与密码。
3. 首次登录修改用户名密码后请尝试重启容器查看修改是否生效，目前发现存在映射的`/app/data`目录有权限不对导致无法修改密码的问题，可尝试 ssh 运行`chmod -R 777 存放路径/pt-nexus/data`或者进入容器终端运行`chmod -R 777 /app/data`。

# 盒子

> 用于解决在 NAS 部署 ptn 无法获取到盒子上的视频信息，如截图与 mediainfo 等，使用`go`语言编写。

1. **安装**
   使用`ssh`连接到盒子上，然后执行如下命令，会自动安装所需的依赖

```bash
# 使用 curl
curl -sL https://github.com/sqing33/Docker.pt-nexus/releases/download/latest/install-pt-nexus-box-proxy.sh | sudo bash
# 或使用 wget
wget -O - https://github.com/sqing33/Docker.pt-nexus/releases/download/latest/install-pt-nexus-box-proxy.sh | sudo bash
```

2. **设置端口**  
   在安装过程中，脚本会提示您输入代理服务需要监听的端口（默认为  9090），您可以直接回车使用默认值，或输入自定义端口后回车。

- **安装目录**：`/opt/pt-nexus-proxy`
- **启动服务**：`cd /opt/pt-nexus-proxy && sudo ./start.sh`
- **停止服务**：`cd /opt/pt-nexus-proxy && sudo ./stop.sh`
- **查看日志**：`tail -f /var/run/pt-nexus-box-proxy.log`

3. **下载器设置**
   安装完成后，代理服务会自动在后台启动。您只需在 PT Nexus 的站点配置中，将远程代理开启，然后端口填入刚刚安装脚本设置的端口即可。
   ![下载器设置](https://img1.pixhost.to/images/9697/655149724_56fed05b56b3ab864c4be77d755982f4.png)
